<HTML><HEAD><META CONTENT="text/html; charset=ISO-8859-1" HTTP-EQUIV="Content-Type"/><TITLE>EMMA Coverage Report</TITLE><STYLE TYPE="text/css"> TABLE,TD,TH {border-style:solid; border-color:black;} TD,TH {background:white;margin:0;line-height:100%;padding-left:0.5em;padding-right:0.5em;} TD {border-width:0 1px 0 0;} TH {border-width:1px 1px 1px 0;} TR TD.h {color:red;} TABLE {border-spacing:0; border-collapse:collapse;border-width:0 0 1px 1px;} P,H1,H2,H3,TH {font-family:verdana,arial,sans-serif;font-size:10pt;} TD {font-family:courier,monospace;font-size:10pt;} TABLE.hdft {border-spacing:0;border-collapse:collapse;border-style:none;} TABLE.hdft TH,TABLE.hdft TD {border-style:none;line-height:normal;} TABLE.hdft TH.tl,TABLE.hdft TD.tl {background:#6699CC;color:white;} TABLE.hdft TD.nv {background:#6633DD;color:white;} .nv A:link {color:white;} .nv A:visited {color:white;} .nv A:active {color:yellow;} TABLE.hdft A:link {color:white;} TABLE.hdft A:visited {color:white;} TABLE.hdft A:active {color:yellow;} .in {color:#356085;} TABLE.s TD {padding-left:0.25em;padding-right:0.25em;} TABLE.s TD.l {padding-left:0.25em;padding-right:0.25em;text-align:right;background:#F0F0F0;} TABLE.s TR.z TD {background:#FF9999;} TABLE.s TR.p TD {background:#FFFF88;} TABLE.s TR.c TD {background:#CCFFCC;} A:link {color:#0000EE;text-decoration:none;} A:visited {color:#0000EE;text-decoration:none;} A:hover {color:#0000EE;text-decoration:underline;} TABLE.cn {border-width:0 0 1px 0;} TABLE.s {border-width:1px 0 1px 1px;} TD.h {color:red;border-width:0 1px 0 0;} TD.f {border-width:0 1px 0 1px;} TD.hf {color:red;border-width:0 1px 0 1px;} TH.f {border-width:1px 1px 1px 1px;} TR.cis TD {background:#F0F0F0;} TR.cis TD {border-width:1px 1px 1px 0;} TR.cis TD.h {color:red;border-width:1px 1px 1px 0;} TR.cis TD.f {border-width:1px 1px 1px 1px;} TR.cis TD.hf {color:red;border-width:1px 1px 1px 1px;} TD.b {border-style:none;background:transparent;line-height:50%;}  TD.bt {border-width:1px 0 0 0;background:transparent;line-height:50%;} TR.o TD {background:#F0F0F0;}TABLE.it {border-style:none;}TABLE.it TD,TABLE.it TH {border-style:none;}</STYLE></HEAD><BODY><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="tl"><A HREF="http://emma.sourceforge.net/">EMMA</A> Coverage Report (generated Mon Jan 28 10:01:43 GMT 2013)</TH></TR><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="8.html">org.springframework.data.elasticsearch.core</A>]</TD></TR></TABLE><H2>COVERAGE SUMMARY FOR SOURCE FILE [<SPAN CLASS="in">ElasticsearchTemplate.java</SPAN>]</H2><TABLE CELLSPACING="0" WIDTH="100%"><TR><TH>name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD>ElasticsearchTemplate.java</TD><TD>100% (2/2)</TD><TD>97%  (28/29)</TD><TD>81%  (565/700)</TD><TD>86%  (76.4/89)</TD></TR></TABLE><H3>COVERAGE BREAKDOWN BY CLASS AND METHOD</H3><TABLE CLASS="cn" CELLSPACING="0" WIDTH="100%"><TR><TH CLASS="f">name</TH><TH>class, %</TH><TH>method, %</TH><TH>block, %</TH><TH>line, %</TH></TR><TR><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD><TD CLASS="b"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#0">ElasticsearchTemplate</A></TD><TD>100% (1/1)</TD><TD>96%  (26/27)</TD><TD CLASS="h">79%  (513/648)</TD><TD>85%  (70.4/83)</TD></TR><TR><TD CLASS="f"><A HREF="#1">createIndex (String): boolean</A></TD><TD> </TD><TD CLASS="h">0%   (0/1)</TD><TD CLASS="h">0%   (0/19)</TD><TD CLASS="h">0%   (0/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#2">mapResult (String, Class): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">37%  (11/30)</TD><TD CLASS="h">60%  (3/5)</TD></TR><TR><TD CLASS="f"><A HREF="#3">bulkIndex (List): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">39%  (30/76)</TD><TD CLASS="h">55%  (6/11)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#4">prepareIndex (IndexQuery): IndexRequestBuilder</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">56%  (22/39)</TD><TD CLASS="h">50%  (2/4)</TD></TR><TR><TD CLASS="f"><A HREF="#5">createIndexIfNotCreated (String): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">58%  (7/12)</TD><TD CLASS="h">58%  (0.6/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#6">prepareSearch (Query, Class): SearchRequestBuilder</A></TD><TD> </TD><TD>100% (1/1)</TD><TD CLASS="h">71%  (60/84)</TD><TD CLASS="h">78%  (7/9)</TD></TR><TR><TD CLASS="f"><A HREF="#7">queryForObject (CriteriaQuery, Class): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (35/37)</TD><TD>97%  (2.9/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#8">queryForObject (StringQuery, Class): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>95%  (35/37)</TD><TD>97%  (2.9/3)</TD></TR><TR><TD CLASS="f"><A HREF="#9">ElasticsearchTemplate (Client, ElasticsearchConverter): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>97%  (28/29)</TD><TD>99%  (6/6)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#a">ElasticsearchTemplate (Client): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#0">access$000 (ElasticsearchTemplate, String, Class): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (5/5)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#c">count (SearchQuery, Class): long</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (37/37)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#d">createIndex (Class): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (9/9)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#e">delete (Class, String): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="f"><A HREF="#f">delete (DeleteQuery, Class): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (29/29)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#10">delete (String, String, String): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#11">getElasticsearchConverter (): ElasticsearchConverter</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (3/3)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#12">getPersistentEntityFor (Class): ElasticsearchPersistentEntity</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (7/7)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#13">index (IndexQuery): String</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (8/8)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#14">indexExists (String): boolean</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (16/16)</TD><TD>100% (1/1)</TD></TR><TR><TD CLASS="f"><A HREF="#15">mapResults (SearchResponse, Class, Pageable): Page</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (11/11)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#16">queryForObject (GetQuery, Class): Object</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (23/23)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#17">queryForPage (CriteriaQuery, Class): Page</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (24/24)</TD><TD>100% (3/3)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#18">queryForPage (SearchQuery, Class): Page</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (28/28)</TD><TD>100% (5/5)</TD></TR><TR><TD CLASS="f"><A HREF="#19">queryForPage (StringQuery, Class): Page</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (18/18)</TD><TD>100% (2/2)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1a">refresh (Class, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (22/22)</TD><TD>100% (3/3)</TD></TR><TR><TD CLASS="f"><A HREF="#1b">refresh (String, boolean): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (17/17)</TD><TD>100% (2/2)</TD></TR><TR><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD><TD CLASS="bt"> </TD></TR><TR CLASS="cis"><TD CLASS="f">class <A HREF="#15">ElasticsearchTemplate$1</A></TD><TD>100% (1/1)</TD><TD>100% (2/2)</TD><TD>100% (52/52)</TD><TD>100% (7/7)</TD></TR><TR><TD CLASS="f"><A HREF="#15">ElasticsearchTemplate$1 (ElasticsearchTemplate, Class, Pageable): void</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (12/12)</TD><TD>100% (1/1)</TD></TR><TR CLASS="o"><TD CLASS="f"><A HREF="#1e">mapResults (SearchResponse): Page</A></TD><TD> </TD><TD>100% (1/1)</TD><TD>100% (40/40)</TD><TD>100% (6/6)</TD></TR></TABLE><P></P><TABLE CLASS="s" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="l">1</TD><TD>package org.springframework.data.elasticsearch.core;</TD></TR><TR><TD CLASS="l">2</TD><TD> </TD></TR><TR><TD CLASS="l">3</TD><TD>import org.codehaus.jackson.map.DeserializationConfig;</TD></TR><TR><TD CLASS="l">4</TD><TD>import org.codehaus.jackson.map.ObjectMapper;</TD></TR><TR><TD CLASS="l">5</TD><TD>import org.elasticsearch.action.bulk.BulkItemResponse;</TD></TR><TR><TD CLASS="l">6</TD><TD>import org.elasticsearch.action.bulk.BulkRequestBuilder;</TD></TR><TR><TD CLASS="l">7</TD><TD>import org.elasticsearch.action.bulk.BulkResponse;</TD></TR><TR><TD CLASS="l">8</TD><TD>import org.elasticsearch.action.count.CountRequestBuilder;</TD></TR><TR><TD CLASS="l">9</TD><TD>import org.elasticsearch.action.get.GetResponse;</TD></TR><TR><TD CLASS="l">10</TD><TD>import org.elasticsearch.action.index.IndexRequestBuilder;</TD></TR><TR><TD CLASS="l">11</TD><TD>import org.elasticsearch.action.search.SearchRequestBuilder;</TD></TR><TR><TD CLASS="l">12</TD><TD>import org.elasticsearch.action.search.SearchResponse;</TD></TR><TR><TD CLASS="l">13</TD><TD>import org.elasticsearch.client.Client;</TD></TR><TR><TD CLASS="l">14</TD><TD>import org.elasticsearch.client.Requests;</TD></TR><TR><TD CLASS="l">15</TD><TD>import org.elasticsearch.common.collect.MapBuilder;</TD></TR><TR><TD CLASS="l">16</TD><TD>import org.elasticsearch.index.query.QueryBuilder;</TD></TR><TR><TD CLASS="l">17</TD><TD>import org.elasticsearch.search.SearchHit;</TD></TR><TR><TD CLASS="l">18</TD><TD>import org.elasticsearch.search.sort.SortOrder;</TD></TR><TR><TD CLASS="l">19</TD><TD>import org.springframework.data.domain.Page;</TD></TR><TR><TD CLASS="l">20</TD><TD>import org.springframework.data.domain.PageImpl;</TD></TR><TR><TD CLASS="l">21</TD><TD>import org.springframework.data.domain.Pageable;</TD></TR><TR><TD CLASS="l">22</TD><TD>import org.springframework.data.domain.Sort;</TD></TR><TR><TD CLASS="l">23</TD><TD>import org.springframework.data.elasticsearch.ElasticsearchException;</TD></TR><TR><TD CLASS="l">24</TD><TD>import org.springframework.data.elasticsearch.core.convert.ElasticsearchConverter;</TD></TR><TR><TD CLASS="l">25</TD><TD>import org.springframework.data.elasticsearch.core.convert.MappingElasticsearchConverter;</TD></TR><TR><TD CLASS="l">26</TD><TD>import org.springframework.data.elasticsearch.core.mapping.ElasticsearchPersistentEntity;</TD></TR><TR><TD CLASS="l">27</TD><TD>import org.springframework.data.elasticsearch.core.mapping.SimpleElasticsearchMappingContext;</TD></TR><TR><TD CLASS="l">28</TD><TD>import org.springframework.data.elasticsearch.core.query.*;</TD></TR><TR><TD CLASS="l">29</TD><TD>import org.springframework.util.Assert;</TD></TR><TR><TD CLASS="l">30</TD><TD> </TD></TR><TR><TD CLASS="l">31</TD><TD>import java.io.IOException;</TD></TR><TR><TD CLASS="l">32</TD><TD>import java.util.ArrayList;</TD></TR><TR><TD CLASS="l">33</TD><TD>import java.util.HashMap;</TD></TR><TR><TD CLASS="l">34</TD><TD>import java.util.List;</TD></TR><TR><TD CLASS="l">35</TD><TD>import java.util.Map;</TD></TR><TR><TD CLASS="l">36</TD><TD> </TD></TR><TR><TD CLASS="l">37</TD><TD>import static org.apache.commons.lang.StringUtils.isBlank;</TD></TR><TR><TD CLASS="l">38</TD><TD>import static org.elasticsearch.action.search.SearchType.DFS_QUERY_THEN_FETCH;</TD></TR><TR><TD CLASS="l"><A NAME="0">39</A></TD><TD>import static org.elasticsearch.client.Requests.indicesExistsRequest;</TD></TR><TR><TD CLASS="l">40</TD><TD>import static org.elasticsearch.client.Requests.refreshRequest;</TD></TR><TR><TD CLASS="l">41</TD><TD> </TD></TR><TR><TD CLASS="l">42</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">43</TD><TD>public class ElasticsearchTemplate implements ElasticsearchOperations {</TD></TR><TR><TD CLASS="l">44</TD><TD> </TD></TR><TR><TD CLASS="l">45</TD><TD>    private Client client;</TD></TR><TR><TD CLASS="l">46</TD><TD>    private ElasticsearchConverter elasticsearchConverter;</TD></TR><TR><TD CLASS="l">47</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">48</TD><TD>    private ObjectMapper objectMapper = new ObjectMapper();</TD></TR><TR><TD CLASS="l">49</TD><TD> </TD></TR><TR><TD CLASS="l">50</TD><TD>    {</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="a">51</A></TD><TD>        objectMapper.configure(DeserializationConfig.Feature.FAIL_ON_UNKNOWN_PROPERTIES, false);</TD></TR><TR><TD CLASS="l">52</TD><TD>    }</TD></TR><TR><TD CLASS="l">53</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="9">54</A></TD><TD>    public ElasticsearchTemplate(Client client) {</TD></TR><TR CLASS="c"><TD CLASS="l">55</TD><TD>        this(client, null);</TD></TR><TR CLASS="c"><TD CLASS="l">56</TD><TD>    }</TD></TR><TR><TD CLASS="l">57</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">58</TD><TD>    public ElasticsearchTemplate(Client client, ElasticsearchConverter elasticsearchConverter) {</TD></TR><TR CLASS="c"><TD CLASS="l">59</TD><TD>        this.client = client;</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="97% line coverage (28 out of 29 instructions)">60</TD><TD TITLE="97% line coverage (28 out of 29 instructions)">        this.elasticsearchConverter = (elasticsearchConverter == null)? new MappingElasticsearchConverter(new SimpleElasticsearchMappingContext()) : elasticsearchConverter ;</TD></TR><TR CLASS="c"><TD CLASS="l">61</TD><TD>    }</TD></TR><TR><TD CLASS="l"><A NAME="d">62</A></TD><TD> </TD></TR><TR><TD CLASS="l">63</TD><TD> </TD></TR><TR><TD CLASS="l">64</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">65</TD><TD>    public &lt;T&gt; boolean createIndex(Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">66</TD><TD>        ElasticsearchPersistentEntity&lt;T&gt; persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">67</TD><TD>        return createIndexIfNotCreated(persistentEntity.getIndexName());</TD></TR><TR><TD CLASS="l"><A NAME="11">68</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">69</TD><TD> </TD></TR><TR><TD CLASS="l">70</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">71</TD><TD>    public ElasticsearchConverter getElasticsearchConverter() {</TD></TR><TR CLASS="c"><TD CLASS="l">72</TD><TD>        return elasticsearchConverter;</TD></TR><TR><TD CLASS="l"><A NAME="16">73</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">74</TD><TD> </TD></TR><TR><TD CLASS="l">75</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">76</TD><TD>    public &lt;T&gt; T queryForObject(GetQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">77</TD><TD>        ElasticsearchPersistentEntity&lt;T&gt; persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">78</TD><TD>        GetResponse response = client.prepareGet(persistentEntity.getIndexName(), persistentEntity.getIndexType(), query.getId())</TD></TR><TR><TD CLASS="l">79</TD><TD>                .execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">80</TD><TD>        return mapResult(response.getSourceAsString(), clazz);</TD></TR><TR><TD CLASS="l"><A NAME="7">81</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">82</TD><TD> </TD></TR><TR><TD CLASS="l">83</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">84</TD><TD>    public &lt;T&gt; T queryForObject(CriteriaQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">85</TD><TD>        Page&lt;T&gt; page =  queryForPage(query,clazz);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="97% line coverage (29 out of 30 instructions)">86</TD><TD TITLE="97% line coverage (29 out of 30 instructions)">        Assert.isTrue(page.getTotalElements() &lt; 2, &#34;Expected 1 but found &#34;+  page.getTotalElements() +&#34; results&#34;);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="96% line coverage (23 out of 24 instructions)">87</TD><TD TITLE="96% line coverage (23 out of 24 instructions)">        return page.getTotalElements() &gt; 0? page.getContent().get(0) : null;</TD></TR><TR><TD CLASS="l"><A NAME="8">88</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">89</TD><TD> </TD></TR><TR><TD CLASS="l">90</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">91</TD><TD>    public &lt;T&gt; T queryForObject(StringQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">92</TD><TD>        Page&lt;T&gt; page =  queryForPage(query,clazz);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="97% line coverage (29 out of 30 instructions)">93</TD><TD TITLE="97% line coverage (29 out of 30 instructions)">        Assert.isTrue(page.getTotalElements() &lt; 2, &#34;Expected 1 but found &#34;+  page.getTotalElements() +&#34; results&#34;);</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="96% line coverage (23 out of 24 instructions)">94</TD><TD TITLE="96% line coverage (23 out of 24 instructions)">        return page.getTotalElements() &gt; 0? page.getContent().get(0) : null;</TD></TR><TR><TD CLASS="l"><A NAME="18">95</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">96</TD><TD> </TD></TR><TR><TD CLASS="l">97</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">98</TD><TD>    public &lt;T&gt; Page&lt;T&gt; queryForPage(SearchQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">99</TD><TD>        SearchRequestBuilder searchRequestBuilder = prepareSearch(query,clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">100</TD><TD>        if(query.getElasticsearchFilter() != null){</TD></TR><TR CLASS="c"><TD CLASS="l">101</TD><TD>            searchRequestBuilder.setFilter(query.getElasticsearchFilter());</TD></TR><TR><TD CLASS="l">102</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">103</TD><TD>        SearchResponse response = searchRequestBuilder.setQuery(query.getElasticsearchQuery()).execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">104</TD><TD>        return  mapResults(response, clazz, query.getPageable());</TD></TR><TR><TD CLASS="l"><A NAME="17">105</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">106</TD><TD> </TD></TR><TR><TD CLASS="l">107</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">108</TD><TD>    public &lt;T&gt; Page&lt;T&gt; queryForPage(CriteriaQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">109</TD><TD>        QueryBuilder elasticsearchQuery = new CriteriaQueryProcessor().createQueryFromCriteria(query.getCriteria());</TD></TR><TR CLASS="c"><TD CLASS="l">110</TD><TD>        SearchResponse response =  prepareSearch(query,clazz)</TD></TR><TR><TD CLASS="l">111</TD><TD>                .setQuery(elasticsearchQuery)</TD></TR><TR><TD CLASS="l">112</TD><TD>                .execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">113</TD><TD>        return  mapResults(response, clazz, query.getPageable());</TD></TR><TR><TD CLASS="l"><A NAME="19">114</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">115</TD><TD> </TD></TR><TR><TD CLASS="l">116</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">117</TD><TD>    public &lt;T&gt; Page&lt;T&gt; queryForPage(StringQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">118</TD><TD>        SearchResponse response =  prepareSearch(query,clazz)</TD></TR><TR><TD CLASS="l">119</TD><TD>                .setQuery(query.getSource())</TD></TR><TR><TD CLASS="l">120</TD><TD>                .execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">121</TD><TD>        return  mapResults(response, clazz, query.getPageable());</TD></TR><TR><TD CLASS="l"><A NAME="c">122</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">123</TD><TD> </TD></TR><TR><TD CLASS="l">124</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">125</TD><TD>    public &lt;T&gt; long count(SearchQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">126</TD><TD>        ElasticsearchPersistentEntity&lt;T&gt; persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">127</TD><TD>        CountRequestBuilder countRequestBuilder = client.prepareCount(persistentEntity.getIndexName())</TD></TR><TR><TD CLASS="l">128</TD><TD>                .setTypes(persistentEntity.getIndexType());</TD></TR><TR CLASS="c"><TD CLASS="l">129</TD><TD>        if(query.getElasticsearchQuery() != null){</TD></TR><TR CLASS="c"><TD CLASS="l">130</TD><TD>            countRequestBuilder.setQuery(query.getElasticsearchQuery());</TD></TR><TR><TD CLASS="l">131</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">132</TD><TD>        return countRequestBuilder.execute().actionGet().count();</TD></TR><TR><TD CLASS="l"><A NAME="13">133</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">134</TD><TD> </TD></TR><TR><TD CLASS="l">135</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">136</TD><TD>    public String index(IndexQuery query) {</TD></TR><TR CLASS="c"><TD CLASS="l">137</TD><TD>        return  prepareIndex(query)</TD></TR><TR><TD CLASS="l">138</TD><TD>                .execute()</TD></TR><TR><TD CLASS="l">139</TD><TD>                .actionGet().getId();</TD></TR><TR><TD CLASS="l"><A NAME="3">140</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">141</TD><TD> </TD></TR><TR><TD CLASS="l">142</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">143</TD><TD>    public void bulkIndex(List&lt;IndexQuery&gt; queries) {</TD></TR><TR CLASS="c"><TD CLASS="l">144</TD><TD>        BulkRequestBuilder bulkRequest = client.prepareBulk();</TD></TR><TR CLASS="c"><TD CLASS="l">145</TD><TD>        for(IndexQuery query : queries){</TD></TR><TR CLASS="c"><TD CLASS="l">146</TD><TD>            bulkRequest.add(prepareIndex(query));</TD></TR><TR><TD CLASS="l">147</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">148</TD><TD>        BulkResponse bulkResponse = bulkRequest.execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">149</TD><TD>        if (bulkResponse.hasFailures()) {</TD></TR><TR CLASS="z"><TD CLASS="l">150</TD><TD>            Map&lt;String, String&gt; failedDocuments = new HashMap&lt;String, String&gt;();</TD></TR><TR CLASS="z"><TD CLASS="l">151</TD><TD>            for (BulkItemResponse item : bulkResponse.items()) {</TD></TR><TR CLASS="z"><TD CLASS="l">152</TD><TD>                if (item.failed())</TD></TR><TR CLASS="z"><TD CLASS="l">153</TD><TD>                    failedDocuments.put(item.getId(), item.failureMessage());</TD></TR><TR><TD CLASS="l">154</TD><TD>            }</TD></TR><TR CLASS="z"><TD CLASS="l">155</TD><TD>            throw new ElasticsearchException(&#34;Bulk indexing has failures. Use ElasticsearchException.getFailedDocuments() for detailed messages [&#34; + failedDocuments+&#34;]&#34;, failedDocuments);</TD></TR><TR><TD CLASS="l">156</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="10">157</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">158</TD><TD> </TD></TR><TR><TD CLASS="l">159</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">160</TD><TD>    public String delete(String indexName, String type, String id) {</TD></TR><TR CLASS="c"><TD CLASS="l">161</TD><TD>        return client.prepareDelete(indexName, type, id)</TD></TR><TR><TD CLASS="l">162</TD><TD>                .execute().actionGet().getId();</TD></TR><TR><TD CLASS="l"><A NAME="e">163</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">164</TD><TD> </TD></TR><TR><TD CLASS="l">165</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">166</TD><TD>    public &lt;T&gt; String delete(Class&lt;T&gt; clazz, String id) {</TD></TR><TR CLASS="c"><TD CLASS="l">167</TD><TD>        ElasticsearchPersistentEntity persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">168</TD><TD>        return delete(persistentEntity.getIndexName(), persistentEntity.getIndexType(), id);</TD></TR><TR><TD CLASS="l"><A NAME="f">169</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">170</TD><TD> </TD></TR><TR><TD CLASS="l">171</TD><TD>    @Override</TD></TR><TR><TD CLASS="l">172</TD><TD>    public &lt;T&gt; void delete(DeleteQuery query, Class&lt;T&gt; clazz) {</TD></TR><TR CLASS="c"><TD CLASS="l">173</TD><TD>        ElasticsearchPersistentEntity persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">174</TD><TD>        client.prepareDeleteByQuery(persistentEntity.getIndexName())</TD></TR><TR><TD CLASS="l">175</TD><TD>                .setTypes(persistentEntity.getIndexType())</TD></TR><TR><TD CLASS="l">176</TD><TD>                .setQuery(query.getElasticsearchQuery())</TD></TR><TR><TD CLASS="l"><A NAME="5">177</A></TD><TD>                .execute().actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">178</TD><TD>    }</TD></TR><TR><TD CLASS="l">179</TD><TD> </TD></TR><TR><TD CLASS="l">180</TD><TD>    private boolean createIndexIfNotCreated(String indexName) {</TD></TR><TR CLASS="p"><TD CLASS="l" TITLE="58% line coverage (7 out of 12 instructions)"><A NAME="14">181</A></TD><TD TITLE="58% line coverage (7 out of 12 instructions)">        return  indexExists(indexName) ||  createIndex(indexName);</TD></TR><TR><TD CLASS="l">182</TD><TD>    }</TD></TR><TR><TD CLASS="l">183</TD><TD> </TD></TR><TR><TD CLASS="l">184</TD><TD>    private boolean indexExists(String indexName) {</TD></TR><TR CLASS="c"><TD CLASS="l">185</TD><TD>        return client.admin()</TD></TR><TR><TD CLASS="l">186</TD><TD>                .indices()</TD></TR><TR><TD CLASS="l"><A NAME="1">187</A></TD><TD>                .exists(indicesExistsRequest(indexName)).actionGet().exists();</TD></TR><TR><TD CLASS="l">188</TD><TD>    }</TD></TR><TR><TD CLASS="l">189</TD><TD> </TD></TR><TR><TD CLASS="l">190</TD><TD>    private boolean createIndex(String indexName) {</TD></TR><TR CLASS="z"><TD CLASS="l">191</TD><TD>        return client.admin().indices().create(Requests.createIndexRequest(indexName).</TD></TR><TR><TD CLASS="l"><A NAME="6">192</A></TD><TD>                settings(new MapBuilder&lt;String, String&gt;().put(&#34;index.refresh_interval&#34;, &#34;-1&#34;).map())).actionGet().acknowledged();</TD></TR><TR><TD CLASS="l">193</TD><TD>    }</TD></TR><TR><TD CLASS="l">194</TD><TD> </TD></TR><TR><TD CLASS="l">195</TD><TD>    private &lt;T&gt; SearchRequestBuilder prepareSearch(Query query, Class&lt;T&gt; clazz){</TD></TR><TR CLASS="c"><TD CLASS="l">196</TD><TD>        int startRecord=0;</TD></TR><TR CLASS="c"><TD CLASS="l">197</TD><TD>        if(query.getPageable() != null){</TD></TR><TR CLASS="c"><TD CLASS="l">198</TD><TD>            startRecord = ((query.getPageable().getPageNumber() - 1) * query.getPageable().getPageSize());</TD></TR><TR><TD CLASS="l">199</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">200</TD><TD>        ElasticsearchPersistentEntity persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">201</TD><TD>        SearchRequestBuilder searchRequestBuilder = client.prepareSearch(persistentEntity.getIndexName())</TD></TR><TR><TD CLASS="l">202</TD><TD>                .setSearchType(DFS_QUERY_THEN_FETCH)</TD></TR><TR><TD CLASS="l">203</TD><TD>                .setTypes(persistentEntity.getIndexType())</TD></TR><TR><TD CLASS="l">204</TD><TD>                .setFrom(startRecord &lt; 0 ? 0 : startRecord)</TD></TR><TR><TD CLASS="l">205</TD><TD>                .setSize(query.getPageable() != null ? query.getPageable().getPageSize() : 10);</TD></TR><TR><TD CLASS="l">206</TD><TD> </TD></TR><TR CLASS="c"><TD CLASS="l">207</TD><TD>        if(query.getSort() != null){</TD></TR><TR CLASS="z"><TD CLASS="l">208</TD><TD>            for(Sort.Order order : query.getSort()){</TD></TR><TR CLASS="z"><TD CLASS="l">209</TD><TD>                searchRequestBuilder.addSort(order.getProperty(), order.getDirection() == Sort.Direction.DESC? SortOrder.DESC : SortOrder.ASC);</TD></TR><TR><TD CLASS="l">210</TD><TD>            }</TD></TR><TR><TD CLASS="l">211</TD><TD>        }</TD></TR><TR CLASS="c"><TD CLASS="l">212</TD><TD>        return searchRequestBuilder;</TD></TR><TR><TD CLASS="l"><A NAME="4">213</A></TD><TD>    }</TD></TR><TR><TD CLASS="l">214</TD><TD> </TD></TR><TR><TD CLASS="l">215</TD><TD>    private IndexRequestBuilder prepareIndex(IndexQuery query){</TD></TR><TR><TD CLASS="l">216</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">217</TD><TD>            ElasticsearchPersistentEntity persistentEntity = getPersistentEntityFor(query.getObject().getClass());</TD></TR><TR CLASS="c"><TD CLASS="l">218</TD><TD>            return client.prepareIndex(persistentEntity.getIndexName(), persistentEntity.getIndexType(), query.getId())</TD></TR><TR><TD CLASS="l">219</TD><TD>                    .setSource(objectMapper.writeValueAsString(query.getObject()));</TD></TR><TR CLASS="z"><TD CLASS="l">220</TD><TD>        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">221</TD><TD>            throw new ElasticsearchException(&#34;failed to index the document [id: &#34; + query.getId() +&#34;]&#34;,e);</TD></TR><TR><TD CLASS="l"><A NAME="1b">222</A></TD><TD>        }</TD></TR><TR><TD CLASS="l">223</TD><TD>    }</TD></TR><TR><TD CLASS="l">224</TD><TD> </TD></TR><TR><TD CLASS="l">225</TD><TD>    public void refresh(String indexName, boolean waitForOperation) {</TD></TR><TR CLASS="c"><TD CLASS="l">226</TD><TD>        client.admin().indices()</TD></TR><TR><TD CLASS="l"><A NAME="1a">227</A></TD><TD>                .refresh(refreshRequest(indexName).waitForOperations(waitForOperation)).actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">228</TD><TD>    }</TD></TR><TR><TD CLASS="l">229</TD><TD> </TD></TR><TR><TD CLASS="l">230</TD><TD>    public &lt;T&gt; void refresh(Class&lt;T&gt; clazz, boolean waitForOperation) {</TD></TR><TR CLASS="c"><TD CLASS="l">231</TD><TD>        ElasticsearchPersistentEntity persistentEntity = getPersistentEntityFor(clazz);</TD></TR><TR CLASS="c"><TD CLASS="l">232</TD><TD>        client.admin().indices()</TD></TR><TR><TD CLASS="l"><A NAME="12">233</A></TD><TD>                .refresh(refreshRequest(persistentEntity.getIndexName()).waitForOperations(waitForOperation)).actionGet();</TD></TR><TR CLASS="c"><TD CLASS="l">234</TD><TD>    }</TD></TR><TR><TD CLASS="l">235</TD><TD> </TD></TR><TR><TD CLASS="l">236</TD><TD>    private ElasticsearchPersistentEntity getPersistentEntityFor(Class clazz){</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="15">237</A></TD><TD>        return elasticsearchConverter.getMappingContext().getPersistentEntity(clazz);</TD></TR><TR><TD CLASS="l">238</TD><TD>    }</TD></TR><TR><TD CLASS="l">239</TD><TD> </TD></TR><TR><TD CLASS="l"><A NAME="1e">240</A></TD><TD>    private &lt;T&gt; Page&lt;T&gt; mapResults(SearchResponse response, final Class&lt;T&gt; elementType,final Pageable pageable){</TD></TR><TR CLASS="c"><TD CLASS="l">241</TD><TD>        ResultsMapper&lt;T&gt; resultsMapper =  new ResultsMapper&lt;T&gt;(){</TD></TR><TR><TD CLASS="l">242</TD><TD>            @Override</TD></TR><TR><TD CLASS="l">243</TD><TD>            public Page&lt;T&gt; mapResults(SearchResponse response) {</TD></TR><TR CLASS="c"><TD CLASS="l">244</TD><TD>                long totalHits =  response.getHits().totalHits();</TD></TR><TR CLASS="c"><TD CLASS="l">245</TD><TD>                List&lt;T&gt; results = new ArrayList&lt;T&gt;();</TD></TR><TR CLASS="c"><TD CLASS="l">246</TD><TD>                for (SearchHit hit : response.getHits()) {</TD></TR><TR CLASS="c"><TD CLASS="l">247</TD><TD>                    if (hit != null) {</TD></TR><TR CLASS="c"><TD CLASS="l">248</TD><TD>                        results.add(mapResult(hit.sourceAsString(), elementType));</TD></TR><TR><TD CLASS="l">249</TD><TD>                    }</TD></TR><TR><TD CLASS="l">250</TD><TD>                }</TD></TR><TR CLASS="c"><TD CLASS="l">251</TD><TD>                return new PageImpl&lt;T&gt;(results, pageable, totalHits);</TD></TR><TR><TD CLASS="l">252</TD><TD>            }</TD></TR><TR><TD CLASS="l">253</TD><TD>        };</TD></TR><TR CLASS="c"><TD CLASS="l"><A NAME="2">254</A></TD><TD>        return resultsMapper.mapResults(response);</TD></TR><TR><TD CLASS="l">255</TD><TD>    }</TD></TR><TR><TD CLASS="l">256</TD><TD> </TD></TR><TR><TD CLASS="l">257</TD><TD>    private &lt;T&gt; T mapResult(String source, Class&lt;T&gt; clazz){</TD></TR><TR CLASS="c"><TD CLASS="l">258</TD><TD>        if(isBlank(source)){</TD></TR><TR CLASS="c"><TD CLASS="l">259</TD><TD>            return null;</TD></TR><TR><TD CLASS="l">260</TD><TD>        }</TD></TR><TR><TD CLASS="l">261</TD><TD>        try {</TD></TR><TR CLASS="c"><TD CLASS="l">262</TD><TD>            return objectMapper.readValue(source, clazz);</TD></TR><TR CLASS="z"><TD CLASS="l">263</TD><TD>        } catch (IOException e) {</TD></TR><TR CLASS="z"><TD CLASS="l">264</TD><TD>            throw new ElasticsearchException(&#34;failed to map source [ &#34; + source + &#34;] to class &#34; + clazz.getSimpleName() , e);</TD></TR><TR><TD CLASS="l">265</TD><TD>        }</TD></TR><TR><TD CLASS="l">266</TD><TD>    }</TD></TR><TR><TD CLASS="l">267</TD><TD>}</TD></TR></TABLE><P></P><TABLE CLASS="hdft" CELLSPACING="0" WIDTH="100%"><TR><TD CLASS="nv">[<A HREF="../index.html">all classes</A>][<A HREF="8.html">org.springframework.data.elasticsearch.core</A>]</TD></TR><TR><TD CLASS="tl"><A HREF="http://sourceforge.net/projects/emma">EMMA 2.0.5312</A> (C) Vladimir Roubtsov</TD></TR></TABLE></BODY></HTML>